# â—¬ Nexus IDE Architecture in Chevron
# SCP-Powered AI Development Environment (Self-Specification)
# 7 SCP modules Â· 4 layers Â· 5 glyph primitives
#
# Nexus eats its own dog food â€” this file defines the IDE's own
# architecture using the same Chevron language it processes.

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Type Declarations
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type ContextItem = { content: str, source: str, category: str, tokens: int, score: float }
type SessionState = { architecture: str, active_module: str, code_state: str, edit_history: str }
type EditEntry = { module: str, code_before: str, code_after: str, verified: bool }
type ContractSnapshot = { module: str, interface: str, version: int, frozen: bool }
type ProviderConfig = { provider_name: str, model: str, api_key: str }
type ProviderResponse = { content: str, provider: str, model: str, tokens_used: int }
type ArchitectureSpec = { name: str, modules: str, global_constraints: str }
type TaskPlan = { module: str, request: str, dependencies: str }
type ExecuteResult = { module: str, code: str, success: bool }
type VerifyResult = { clean: bool, violations: str }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Layer 1: Context Kernel
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

spec EntropyScorer
    exports score, score_all, compute_entropy
    forbidden [Conductor, Planner, Executor, Verifier, EditLedger]
    constraint "Pure function â€” no side effects, no I/O"
    constraint "Scores must be clamped to [0.0, 1.0]"
    constraint "Contracts always score 1.0 (source of truth)"
    constraint "Active module items get 15% boost"
    constraint "Items from unrelated modules get 50% penalty"
    constraint "Conversation items decay exponentially with age"
    # â—¬ [ContextItem] â†’ score_all â†’ [scored items] â†’ ð“‚€
end

spec ContextPruner
    exports prune, compression_ratio
    forbidden [Conductor, Planner, Executor, Verifier, EditLedger]
    constraint "Never prune items with category='contract'"
    constraint "Prune expendable items first, then preferred"
    constraint "Output total tokens <= budget"
    constraint "Pure function â€” deterministic given same inputs"
    # Ó¨ [scored items] â†’ prune(budget) â†’ [surviving items] â†’ ð“‚€
end

spec SCPRetriever
    depends_on [EntropyScorer, ContextPruner]
    imports EntropyScorer, ContextPruner
    exports retrieve, get_dependency_graph
    forbidden [Conductor, Planner, Executor, Verifier]
    constraint "RAG Denial: only return interfaces for dependencies, never full code"
    constraint "Forbidden modules are completely invisible"
    constraint "Global constraints always included"
    constraint "Must not modify architecture spec"
    # â—¬ (module_name, ArchitectureSpec) â†’ retrieve â†’ [ContextItem] â†’ Ó¨
end

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Layer 2: Session Protocol
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

spec EditLedger
    exports record, get_edits, regression_rate, clean_streak, save, load
    forbidden [Conductor, Planner, Executor, EntropyScorer, ContextPruner]
    constraint "Append-only â€” never delete or modify past entries"
    constraint "Must persist to disk (JSON) for session recovery"
    constraint "Must track verified vs unverified edits separately"
    # â—¬ EditEntry â†’ record â†’ ð“‚€ (append to history)
end

spec ContractCache
    exports freeze, get, invalidate, is_frozen, save, load
    forbidden [Conductor, Planner, Executor, EntropyScorer, ContextPruner]
    constraint "Frozen contracts are immutable snapshots"
    constraint "Version increments on each freeze"
    constraint "Must persist to disk for session recovery"
    constraint "Invalidation resets frozen status"
    # â˜¾ (module, interface) â†’ freeze â†’ ContractSnapshot â†’ ð“‚€
end

spec SessionManager
    depends_on [EditLedger, ContractCache]
    imports EditLedger, ContractCache
    exports set_active_module, update_code, session_health, save, load
    forbidden [Conductor, Planner, Executor]
    constraint "Single source of truth for all session state"
    constraint "Must validate module names against architecture"
    constraint "Must persist full state atomically"
    # â˜¤ SessionState â†” EditLedger + ContractCache â†’ ð“‚€
end

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Layer 3: Orchestrator
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

spec Planner
    depends_on [SessionManager]
    imports SessionManager
    exports decompose
    forbidden [EntropyScorer, ContextPruner, EditLedger, ContractCache]
    constraint "Must respect dependency ordering (topological sort)"
    constraint "Must produce exactly one task per module"
    constraint "Must not invoke AI â€” decomposition is deterministic"
    # â—¬ request â†’ decompose â†’ [TaskPlan] â†’ â˜¤
end

spec Executor
    depends_on [SCPRetriever, SessionManager]
    imports SCPRetriever, SessionManager
    exports execute
    forbidden [EditLedger, ContractCache, EntropyScorer, ContextPruner]
    constraint "Must include forbidden module warning in system prompt"
    constraint "Must extract code from markdown fences if present"
    constraint "Must record all edits to session"
    constraint "One AI call per module â€” no retry loops"
    # â˜¤ TaskPlan â†’ execute(provider) â†’ ExecuteResult â†’ â˜¾
end

spec Verifier
    depends_on [SessionManager]
    imports SessionManager
    exports verify
    forbidden [Planner, Executor, SCPRetriever, EntropyScorer]
    constraint "Must check: no forbidden imports"
    constraint "Must check: no global mutable state"
    constraint "Must compare before/after diffs"
    constraint "Must NOT use AI â€” static analysis only"
    # ð“‚€ ExecuteResult â†’ verify â†’ VerifyResult â†’ ð“‚€
end

spec Conductor
    depends_on [Planner, Executor, Verifier, SessionManager]
    imports Planner, Executor, Verifier, SessionManager
    exports handle_request, get_context_report
    forbidden [EntropyScorer, ContextPruner, EditLedger, ContractCache]
    constraint "Must follow Plan â†’ Execute â†’ Verify pipeline per module"
    constraint "Must freeze contracts after verified clean edits"
    constraint "Must update session health after every edit"
    constraint "Primary entry point for all AI-assisted development"
    # â—¬ request â†’ â˜¤ Planner â†’ â˜¾ Executor â†’ ð“‚€ Verifier â†’ ð“‚€
end

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# AI Provider Abstraction
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

spec AIProvider
    exports generate, is_available
    forbidden [Conductor, Planner, Verifier, EntropyScorer, SessionManager]
    constraint "Stateless â€” no memory between calls"
    constraint "Must handle rate limiting and retries internally"
    constraint "Must normalize responses to ProviderResponse"
    constraint "Lazy-loaded â€” import SDK only when first used"
    # â˜¤ (prompt, system_instruction) â†’ generate â†’ ProviderResponse â†’ ð“‚€
end

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Full DAG
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# â—¬ EntropyScorer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# Ó¨ ContextPruner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#                               â”œâ”€â”€ â—¬ SCPRetriever â”€â”€ â˜¾ Executor
# â—¬ EditLedger â”€â”€â”€â”€â”            â”‚                        â”‚
# â˜¾ ContractCache â”€â”¤            â”‚                        â–¼
#                  â”œâ”€â”€ â˜¤ SessionManager â”€â”€ â—¬ Planner   ð“‚€ Verifier
#                                              â”‚          â”‚
#                                              â””â”€â”€â”€ â˜¤ Conductor
#                                                      â”‚
#                                                 â˜¤ AIProvider
#
# ð“‚€ ProgressWitness observes all, modifies nothing

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Pipeline demo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Request arrives â†’ planner decomposes â†’ each module generated in isolation
â—¬ (â˜¤ [["Add auth to the API"]]) â†’ Ó¨ {!= "forbidden"} â†’ ð“‚€
